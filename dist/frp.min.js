/*! frp 2014-07-10 */
"use strict";function arrayCopy(a,b,c,d,e){for(var f=0;e>f;++f)c[f+d]=a[f+b]}function Queue(a){this._capacity=a,this._length=0,this._front=0,this._makeCapacity()}function tryCatch1(a,b,c){try{return a.call(b,c)}catch(d){return errorObj.e=d,errorObj}}function Async(){this._isTickUsed=!1,this._schedule=schedule,this._length=0,this._lateBuffer=new Queue(16),this._functionBuffer=new Queue(65536);var a=this;this.consumeFunctionBuffer=function(){a._consumeFunctionBuffer()}}function Unresolved(){}function Accessor(a,b,c){this._resolved=a===!0,this._value=b,this._failed=!1,this._errors=void 0,this._resolveHandlers=void 0,this._unresolveHandlers=void 0,this._errorHandlers=void 0,this._broadcastPending=!1,this._broadcastGroup=0,this._broadcastHandlers=void 0,this._finalized=c===!0}function ConstantAccessor(a,b){Accessor.call(this,a,b,!0)}function ValueAccessor(a,b){Accessor.call(this,a,b)}function PropertyAccessor(a,b){Accessor.call(this),this._accessor=a,this._property=b,this._path=b.split(".");var c=this;a.observe(function(a){for(var b=1;b<c._path.length;++b){if(!a||!a.hasOwnProperty(c._path[b]))return c._unresolve();a=a[c._path[b]]}c._resolve(a)},function(){c._unresolve()},function(a){c._throw(a)})}function makeArrayResolver(a,b){return function(){if(a._itemsResolved[b]=!0,_.every(a._itemsResolved)){for(var c=[],d=0;d<a._items.length;++d)c.push(a._items[d]._value);a._resolve(c)}}}function makeArrayUnresolver(a,b){return function(){a._itemsResolved[b]=!1,a._unresolve()}}function makeArrayErrorThrower(a){return function(b){a._throw(b)}}function ArrayAccessor(a){Accessor.call(this),this._accessor=a,this._items=void 0,this._itemsResolved=void 0;var b=this;a.observe(function(a){if(b._items=[],b._itemsResolved=[],0===a.length)b._resolve([]);else for(var c=0;c<a.length;++c){b._items.push(a[c]),b._itemsResolved.push(!1);var d=a[c];d instanceof Accessor||(b._items[c]=d=frp.constant(d)),d.observe(makeArrayResolver(b,c),makeArrayUnresolver(b,c),makeArrayErrorThrower(b))}},function(){b._items=void 0,b._itemsResolved=void 0,b._unresolve()},function(a){b._throw(a)})}function makeObjectResolver(a,b){return function(c){a._object[b]=c,_.every(a._object,Unresolved.not)&&a._resolve(_.clone(a._object))}}function makeObjectUnresolver(a,b){return function(){a._object[b]=new Unresolved,a._unresolve()}}function makeObjectErrorThrower(a){return function(b){a._throw(b)}}function ObjectAccessor(a){Accessor.call(this),this._object={};var b=0,c=this;for(var d in a)a[d]instanceof Accessor?(b++,a[d].observe(makeObjectResolver(c,d),makeObjectUnresolver(c,d),makeObjectErrorThrower(c))):c._object[d]=a[d];0===b&&c._resolve(this._object,!0)}function makeJoinResolver(a,b){return function(){if(a._accessorsResolved[b]=!0,_.every(a._accessorsResolved)){for(var c=[],d=0;d<a._accessors.length;++d)c.push(a._accessors[d]._value);var e=a._fcn.apply(void 0,c);e instanceof Accessor?e.observe(function(b){a._resolve(b)},function(){a._unresolve()},function(b){a._throw(b)}):a._resolve(e)}}}function makeJoinUnresolver(a,b){return function(){a._accessorsResolved[b]=!1,a._unresolve()}}function makeJoinErrorThrower(a){return function(b){a._throw(b)}}function JoinAccessor(){Accessor.call(this),this._fcn=arguments[arguments.length-1],this._accessors=[],this._accessorsResolved=[];for(var a=this,b=0;b<arguments.length-1;++b){a._accessors.push(arguments[b]),a._accessorsResolved.push(!1);var c=arguments[b];c instanceof Accessor||(a._accessors[b]=c=frp.constant(c)),c.observe(makeJoinResolver(a,b),makeJoinUnresolver(a,b),makeJoinErrorThrower(a))}}function FutureAccessor(a,b){Accessor.call(this),this._fcn=b,this._args=frp.all(a);var c=this;this._args.observe(function(a){var b=c._fcn.apply(void 0,a);b instanceof Accessor?b.observe(function(a){c._resolve(a)},function(){c._unresolve()},function(a){c._throw(a)}):c._resolve(b)},function(){c._unresolve()},function(a){c._throw(a)})}function PromiseAccessor(a){Accessor.call(this);var b=this;a.then(function(a){b._resolve(a,!0)},function(a){b._throw(a)})}function DelayAccessor(a,b){Accessor.call(this),this._accessor=a,this._delay=b,this._timeout=null;var c=this;a.observe(function(a){c._timeout&&clearTimeout(c._timeout),c._timeout=setTimeout(function(){c._resolve(a),c._timeout=null},c._delay)},function(){c._unresolve()},function(a){c._throw(a)})}var _=require("lodash"),Promise=require("bluebird").Promise,schedule,_MutationObserver;if("object"==typeof process&&"string"==typeof process.version)schedule=function(a){process.nextTick(a)};else if("undefined"!=typeof MutationObserver&&(_MutationObserver=MutationObserver)||"undefined"!=typeof WebKitMutationObserver&&(_MutationObserver=WebKitMutationObserver))schedule=function(){var a=document.createElement("div"),b=void 0,c=new _MutationObserver(function(){var a=b;b=void 0,a()});return c.observe(a,{attributes:!0}),function(c){b=c,a.setAttribute("class","foo")}}();else{if("undefined"==typeof setTimeout)throw new Error("no async scheduler available");schedule=function(a){setTimeout(a,0)}}Queue.prototype._willBeOverCapacity=function(a){return this._capacity<a},Queue.prototype._pushOne=function(a){var b=this.length();this._checkCapacity(b+1);var c=this._front+b&this._capacity-1;this[c]=a,this._length=b+1},Queue.prototype.push=function(a,b,c){var d=this.length()+3;if(this._willBeOverCapacity(d))return this._pushOne(a),this._pushOne(b),void this._pushOne(c);var e=this._front+d-3;this._checkCapacity(d);var f=this._capacity-1;this[e+0&f]=a,this[e+1&f]=b,this[e+2&f]=c,this._length=d},Queue.prototype.shift=function(){var a=this._front,b=this[a];return this[a]=void 0,this._front=a+1&this._capacity-1,this._length--,b},Queue.prototype.length=function(){return this._length},Queue.prototype._makeCapacity=function(){for(var a=this._capacity,b=0;a>b;++b)this[b]=void 0},Queue.prototype._checkCapacity=function(a){this._capacity<a&&this._resizeTo(this._capacity<<3)},Queue.prototype._resizeTo=function(a){var b=this._front,c=this._capacity,d=new Array(c),e=this.length();if(arrayCopy(this,0,d,0,c),this._capacity=a,this._makeCapacity(),this._front=0,c>=b+e)arrayCopy(d,b,this,0,e);else{var f=e-(b+e&c-1);arrayCopy(d,b,this,0,f),arrayCopy(d,0,this,f,e-f)}};var errorObj={e:{}},_process="undefined"!=typeof process?process:void 0;Async.prototype.haveItemsQueued=function(){return this._length>0},Async.prototype.invokeLater=function(a,b,c){void 0===_process||null===_process.domain||a.domain||(a=_process.domain.bind(a)),this._lateBuffer.push(a,b,c),this._queueTick()},Async.prototype.invoke=function(a,b,c){void 0===_process||null===_process.domain||a.domain||(a=_process.domain.bind(a));var d=this._functionBuffer;d.push(a,b,c),this._length=d.length(),this._queueTick()},Async.prototype._consumeFunctionBuffer=function(){for(var a=this._functionBuffer;a.length()>0;){var b=a.shift(),c=a.shift(),d=a.shift();b.call(c,d)}this._reset(),this._consumeLateBuffer()},Async.prototype._consumeLateBuffer=function(){for(var a=this._lateBuffer;a.length()>0;){var b=a.shift(),c=a.shift(),d=a.shift(),e=tryCatch1(b,c,d);if(e===errorObj){if(this._queueTick(),null===b.domain)throw e.e;b.domain.emit("error",e.e)}}},Async.prototype._queueTick=function(){this._isTickUsed||(this._schedule(this.consumeFunctionBuffer),this._isTickUsed=!0)},Async.prototype._reset=function(){this._isTickUsed=!1,this._length=0};var async=new Async;Unresolved.is=function(a){return a instanceof Unresolved},Unresolved.not=function(a){return!(a instanceof Unresolved)},Accessor.prototype._broadcast=function(){var a,b;if(16&this._broadcastGroup?a=this._value:32&this._broadcastGroup&&(a=this._errors),1&this._broadcastGroup&&this._resolveHandlers)for(b=0;b<this._resolveHandlers.length;++b)this._resolveHandlers[b].call(void 0,a);if(2&this._broadcastGroup&&this._unresolveHandlers)for(b=0;b<this._unresolveHandlers.length;++b)this._unresolveHandlers[b].call(void 0,a);if(4&this._broadcastGroup&&this._errorHandlers)for(b=0;b<this._errorHandlers.length;++b)this._errorHandlers[b].call(void 0,a);if(8&this._broadcastGroup)for(b=0;b<this._broadcastHandlers.length;++b)this._broadcastHandlers[b].call(void 0,a);this._finalized&&(this._resolveHandlers=void 0,this._unresolveHandlers=void 0,this._errorHandlers=void 0),this._broadcastPending=!1,this._broadcastGroup=0,this._broadcastHandlers=void 0},Accessor.prototype._finalize=function(){this._finalized=!0,this._broadcastPending||(this._resolveHandlers=void 0,this._unresolveHandlers=void 0,this._errorHandlers=void 0,this._broadcastGroup=0,this._broadcastHandlers=void 0)},Accessor.prototype._resolve=function(a,b){if("function"!=typeof b){if(this._resolved&&this._value===a)return;this._resolved=!0,this._value=a,this._failed=!1,this._errors=void 0,this._broadcastGroup=17,this._broadcastHandlers=void 0}else if(0===this._broadcastGroup)this._broadcastGroup=24,this._broadcastHandlers=[b];else if(24===this._broadcastGroup)this._broadcastHandlers.push(b);else if(!(1&this._broadcastGroup))throw new Error("Unable to prime resolve to group "+this._broadcastGroup);this._broadcastPending||(this._broadcastPending=!0,async.invoke(this._broadcast,this))},Accessor.prototype._throw=function(a,b){var c=this._resolved;if(b){if(c)throw new Error("Unable to initialize throw with handler");if(0===this._broadcastGroup)this._broadcastGroup=40,this._broadcastHandlers=[b];else if(40===this._broadcastGroup)this._broadcastHandlers.push(b);else if(!(4&this._broadcastGroup))throw new Error("Unable to prime throw to group "+this._broadcastGroup)}else this._resolved=!1,this._value=void 0,this._failed=!0,void 0===this._errors&&(this._errors=[]),Array.isArray(a)?this._errors=this._errors.concat(a):this._errors.push(a),this._broadcastGroup=c?38:36,this._broadcastHandlers=void 0;this._broadcastPending||(this._broadcastPending=!0,async.invoke(this._broadcast,this))},Accessor.prototype._unresolve=function(){this._resolved&&(this._resolved=!1,this._value=void 0,this._failed=!1,this._errors=void 0,this._broadcastGroup=2,this._broadcastHandlers=void 0,this._broadcastPending||(this._broadcastPending=!0,async.invoke(this._broadcast,this)))},Accessor.prototype.get=function(){return this._resolved?_.clone(this._value):void 0},Accessor.prototype.isGettable=function(){return!0},Accessor.prototype.isSettable=function(){return"function"==typeof this.set},Accessor.prototype.observe=function(a,b,c){return"function"==typeof a&&(this._resolveHandlers||(this._resolveHandlers=[]),this._resolveHandlers.push(a),this._resolved&&this._resolve(this._value,a)),"function"==typeof b&&(this._unresolveHandlers||(this._unresolveHandlers=[]),this._unresolveHandlers.push(b)),"function"==typeof c&&(this._errorHandlers||(this._errorHandlers=[]),this._errorHandlers.push(c),this._failed&&this._throw(this._errors,c)),this},Accessor.prototype.onResolve=function(a){return this.observe(a,null,null)},Accessor.prototype.onUnresolve=function(a){return this.observe(null,a,null)},Accessor.prototype.onError=function(a){return this.observe(null,null,a)},Accessor.prototype.isObject=function(){var a=new ValueAccessor;return this.observe(function(b){a.set("object"==typeof b)},function(){a.set(!1)},function(b){a._throw(b)}),a},Accessor.prototype.isResolved=function(){var a=new ValueAccessor;return this.observe(function(){a.set(!0)},function(){a.set(!1)},function(b){a._throw(b)}),a},Accessor.prototype.isUndefined=function(){var a=new ValueAccessor;return this.observe(function(b){a.set(void 0===b)},function(){a.set(!0)},function(b){a._throw(b)}),a},Accessor.prototype.at=function(a){return new PropertyAccessor(this,"."+a)},Accessor.prototype.delay=function(a){return new DelayAccessor(this,a)},Accessor.prototype.not=function(){var a=new ValueAccessor;return this.observe(function(b){a.set(!b)},function(){a._unresolve()},function(b){a._throw(b)}),a},Accessor.prototype.property=function(a){return new PropertyAccessor(this,a)},Accessor.prototype.startWith=function(a){return this._resolved||this._resolve(a),this},Accessor.prototype.then=function(a){return new FutureAccessor([this],a)},ConstantAccessor.prototype=Object.create(Accessor.prototype),ValueAccessor.prototype=Object.create(Accessor.prototype),ValueAccessor.prototype.set=function(a){this._resolve(a)},PropertyAccessor.prototype=Object.create(Accessor.prototype),PropertyAccessor.prototype.set=function(a){for(var b=this._accessor.get()||{},c=b,d=this._path.length-1,e=1;d>e;++e)c.hasOwnProperty(this._path[e])||(c[this._path[e]]={}),c=c[this._path[e]]||{};c[this._path[d]]=a,this._accessor.set(b)},ArrayAccessor.prototype=Object.create(Accessor.prototype),ObjectAccessor.prototype=Object.create(Accessor.prototype),JoinAccessor.prototype=Object.create(Accessor.prototype),FutureAccessor.prototype=Object.create(Accessor.prototype),PromiseAccessor.prototype=Object.create(Accessor.prototype),DelayAccessor.prototype=Object.create(Accessor.prototype);var frp={};frp.isAccessor=function(a){return a instanceof Accessor},frp.all=function(a){return frp.isAccessor(a)||(a=frp.constant(a)),new ArrayAccessor(a)},frp.cast=function(a){return a instanceof Accessor?a:new ValueAccessor(!0,a)},frp.constant=function(a){return 0===arguments.length?new ConstantAccessor:new ConstantAccessor(!0,a)},frp.deferred=function(a){return new PromiseAccessor(new Promise(a))},frp.future=function(a){for(var b=[],c=1;c<arguments.length;++c)b.push(arguments[c]);return new FutureAccessor(a,b)},frp.join=function(){var a=Object.create(JoinAccessor.prototype);return JoinAccessor.apply(a,arguments),a},frp.state=function(a){if(0===arguments.length)return new ValueAccessor;if(a instanceof Accessor){var b=new ValueAccessor;return a.observe(function(a){b.set(a)},function(){b._unresolve()},function(a){b._throw(a)}),b}return new ValueAccessor(!0,a)},frp.promise=function(a){return new PromiseAccessor(a)},frp.props=function(a){return new ObjectAccessor(a||{})},module.exports=frp;